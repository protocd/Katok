<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ç–æ–∫ - –ö–∞—Ç–∫–∏ –ú–æ—Å–∫–≤—ã</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <!-- Chart.js –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">‚õ∏Ô∏è –ö–∞—Ç–∫–∏ –ú–æ—Å–∫–≤—ã</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="index.html">–ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞—Ç–∫–µ -->
        <div id="rinkInfo" class="card mb-4">
            <div class="card-body">
                <h2 id="rinkName">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
                <p id="rinkAddress" class="text-muted"></p>
                <div id="rinkDetails"></div>
            </div>
        </div>

        <!-- –ë–ª–æ–∫ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">üìä –ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏</h6>
                    </div>
                    <div class="card-body">
                        <div id="popularityChartContainer">
                            <canvas id="popularityChart" height="200"></canvas>
                        </div>
                        <div id="popularityChartEmpty" class="text-center text-muted py-4 d-none">
                            <p class="mb-2">–ü–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç</p>
                            <p class="small">–û—Ü–µ–Ω–∏—Ç–µ –ø–µ—Ä–≤—ã–º –∏–ª–∏ –æ—Ç–º–µ—Ç—å—Ç–µ—Å—å –ø–µ—Ä–≤—ã–º</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">üßä –û—Ü–µ–Ω–∫–∏ –ø–æ—Å–µ—Ç–∏—Ç–µ–ª–µ–π</h6>
                    </div>
                    <div class="card-body">
                        <div id="ratingsChartContainer">
                            <canvas id="ratingsChart" height="200"></canvas>
                        </div>
                        <div id="ratingsChartEmpty" class="text-center text-muted py-4 d-none">
                            <p class="mb-2">–ü–æ–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç</p>
                            <p class="small">–û—Ü–µ–Ω–∏—Ç–µ –ø–µ—Ä–≤—ã–º –∏–ª–∏ –æ—Ç–º–µ—Ç—å—Ç–µ—Å—å –ø–µ—Ä–≤—ã–º</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- –û—Ç–∑—ã–≤—ã -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5>–û—Ç–∑—ã–≤—ã</h5>
                    </div>
                    <div class="card-body">
                        <!-- –§–æ—Ä–º–∞ –æ—Ç–∑—ã–≤–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö) -->
                        <div id="reviewForm" class="d-none mb-4">
                            <h6>–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h6>
                            <p class="text-muted small mb-3">üí° –ù–∞–ø–∏—Å–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–∞ –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ –æ–¥–Ω–æ –ø–æ—Å–µ—â–µ–Ω–∏–µ</p>
                            <form onsubmit="handleReviewSubmit(event)">
                                <div class="mb-3">
                                    <label class="form-label">–û—Ü–µ–Ω–∫–∞</label>
                                    <select class="form-select" id="reviewRating" required>
                                        <option value="5">5 - –û—Ç–ª–∏—á–Ω–æ</option>
                                        <option value="4">4 - –•–æ—Ä–æ—à–æ</option>
                                        <option value="3">3 - –ù–æ—Ä–º–∞–ª—å–Ω–æ</option>
                                        <option value="2">2 - –ü–ª–æ—Ö–æ</option>
                                        <option value="1">1 - –£–∂–∞—Å–Ω–æ</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">–°–æ—Å—Ç–æ—è–Ω–∏–µ –ª—å–¥–∞</label>
                                    <select class="form-select" id="iceCondition">
                                        <option value="">–ù–µ —É–∫–∞–∑–∞–Ω–æ</option>
                                        <option value="excellent">–û—Ç–ª–∏—á–Ω–æ–µ</option>
                                        <option value="good">–•–æ—Ä–æ—à–µ–µ</option>
                                        <option value="fair">–°—Ä–µ–¥–Ω–µ–µ</option>
                                        <option value="poor">–ü–ª–æ—Ö–æ–µ</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å</label>
                                    <select class="form-select" id="crowdLevel">
                                        <option value="">–ù–µ —É–∫–∞–∑–∞–Ω–æ</option>
                                        <option value="low">–ù–∏–∑–∫–∞—è</option>
                                        <option value="medium">–°—Ä–µ–¥–Ω—è—è</option>
                                        <option value="high">–í—ã—Å–æ–∫–∞—è</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">–¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞</label>
                                    <textarea class="form-control" id="reviewText" rows="3"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">–§–æ—Ç–æ</label>
                                    <input type="file" class="form-control" id="reviewPhoto" accept="image/*">
                                </div>
                                <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
                            </form>
                        </div>

                        <!-- –°–ø–∏—Å–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ -->
                        <div id="reviewsList"></div>
                    </div>
                </div>
            </div>

            <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
            <div class="col-md-4">
                <!-- –ß–µ–∫-–∏–Ω -->
                <div class="card mb-3">
                    <div class="card-body">
                        <h6>–û—Ç–º–µ—Ç–∫–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è</h6>
                        <p class="text-muted small">–û—Ç–º–µ—á–∞–π—Å—è, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Å–æ–∑–¥–∞–≤–∞—Ç—å —Å–æ–±—ã—Ç–∏—è –∏ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è—Ç—å—Å—è –∫ –Ω–∏–º</p>
                        <button class="btn btn-success w-100" onclick="handleCheckin()" id="checkinBtn">–Ø –∑–¥–µ—Å—å!</button>
                        <div id="checkinResult" class="mt-2"></div>
                    </div>
                </div>

                <!-- –°–æ–±—ã—Ç–∏—è -->
                <div class="card">
                    <div class="card-header">
                        <h6>–°–æ–±—ã—Ç–∏—è</h6>
                    </div>
                    <div class="card-body">
                        <div id="createEventContainer">
                            <button class="btn btn-primary btn-sm mb-2 w-100" onclick="showCreateEvent()" id="createEventBtn">
                                <span id="createEventIcon">üîí</span> –°–æ–∑–¥–∞—Ç—å —Å–æ–±—ã—Ç–∏–µ
                            </button>
                            <small id="createEventHint" class="text-muted d-block text-center mb-3"></small>
                        </div>
                        <div id="eventsList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/reviews.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const rinkId = urlParams.get('id');
        let currentRinkData = null; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞—Ç–∫–∞

        async function loadRink() {
            const rink = await API.getRink(rinkId);
            if (rink.success) {
                const data = rink.data;
                currentRinkData = data; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö
                
                document.getElementById('rinkName').textContent = data.name;
                document.getElementById('rinkAddress').textContent = data.address || '';
                
                let details = '';
                if (data.district) details += `<span class="badge bg-secondary">${data.district}</span> `;
                if (data.is_paid) details += `<span class="badge bg-warning">–ü–ª–∞—Ç–Ω—ã–π</span> `;
                else details += `<span class="badge bg-success">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π</span> `;
                if (data.working_hours) details += `<p class="mt-2"><strong>–ß–∞—Å—ã —Ä–∞–±–æ—Ç—ã:</strong> ${data.working_hours}</p>`;
                
                document.getElementById('rinkDetails').innerHTML = details;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–∑—ã–≤—ã (—ç—Ç–æ —Ç–∞–∫–∂–µ —Å–∫—Ä–æ–µ—Ç —Ñ–æ—Ä–º—É, –µ—Å–ª–∏ –æ—Ç–∑—ã–≤ —É–∂–µ –µ—Å—Ç—å)
            loadReviews();
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫–∞—Ç–æ–∫ —Ç–µ—Å—Ç–æ–≤—ã–º (–±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π)
        function isTestRink() {
            if (!currentRinkData) return false;
            return (currentRinkData.name && currentRinkData.name.includes('–î–≤–æ—Ä–æ–≤–∞—è —Ç–µ—Ä—Ä–∏—Ç–æ—Ä–∏—è')) ||
                   (currentRinkData.address && currentRinkData.address.includes('–†–æ–≥–æ–≤–æ'));
        }

        async function handleCheckin() {
            if (!Auth.isLoggedIn()) {
                alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏');
                return;
            }
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (position) => {
                    const result = await API.checkin(rinkId, position.coords.latitude, position.coords.longitude);
                    document.getElementById('checkinResult').innerHTML = 
                        result.success ? '<div class="alert alert-success">–û—Ç–º–µ—á–µ–Ω–æ!</div>' : 
                        '<div class="alert alert-danger">' + result.message + '</div>';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–µ—â–µ–Ω–∏–π –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —á–µ–∫-–∏–Ω–∞
                    if (result.success) {
                        loadUserVisitCount();
                    }
                });
            } else {
                alert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
            }
        }

        async function loadUserVisitCount() {
            if (!Auth.isLoggedIn()) {
                const btn = document.getElementById('createEventBtn');
                const hint = document.getElementById('createEventHint');
                if (btn) {
                    btn.disabled = true;
                    btn.classList.add('btn-secondary');
                    btn.classList.remove('btn-primary');
                }
                if (hint) {
                    hint.textContent = '–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏–π';
                }
                return;
            }
            
            if (isTestRink()) {
                updateCreateEventButton(0, true);
                return;
            }
            
            try {
                const result = await API.getUserVisitCount(rinkId);
                if (result.success && result.data.user_visit_count !== undefined) {
                    const visitCount = result.data.user_visit_count;
                    const canCreate = result.data.can_create_event || false;
                    updateCreateEventButton(visitCount, canCreate);
                }
            } catch (error) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏
            }
        }
        
        function updateCreateEventButton(visitCount, canCreate) {
            const btn = document.getElementById('createEventBtn');
            const hint = document.getElementById('createEventHint');
            const icon = document.getElementById('createEventIcon');
            
            if (!btn || !hint || !icon) return;
            
            if (canCreate) {
                btn.disabled = false;
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
                icon.textContent = '‚ûï';
                hint.textContent = '';
                hint.classList.add('d-none');
            } else {
                btn.disabled = true;
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
                icon.textContent = 'üîí';
                const remaining = 5 - visitCount;
                hint.textContent = `–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è –Ω—É–∂–Ω–æ 5 –ø–æ—Å–µ—â–µ–Ω–∏–π (–æ—Å—Ç–∞–ª–æ—Å—å ${remaining})`;
                hint.classList.remove('d-none');
            }
        }
        
        async function showCreateEvent() {
            if (!Auth.isLoggedIn()) {
                alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è');
                return;
            }
            
            if (!isTestRink()) {
                const result = await API.getUserVisitCount(rinkId);
                if (result.success && result.data.user_visit_count !== undefined) {
                    const visitCount = result.data.user_visit_count;
                    if (visitCount < 5) {
                        const remaining = 5 - visitCount;
                        alert(`–î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è –Ω—É–∂–Ω–æ –æ—Ç–º–µ—Ç–∏—Ç—å—Å—å –Ω–∞ –∫–∞—Ç–∫–µ –º–∏–Ω–∏–º—É–º 5 —Ä–∞–∑. –£ –≤–∞—Å: ${visitCount}. –û—Å—Ç–∞–ª–æ—Å—å: ${remaining}`);
                        return;
                    }
                }
            }
            
            const title = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:');
            if (!title) return;
            
            const description = prompt('–û–ø–∏—Å–∞–Ω–∏–µ:');
            const date = prompt('–î–∞—Ç–∞ (YYYY-MM-DD):');
            const time = prompt('–í—Ä–µ–º—è (HH:MM):');
            
            const createResult = await API.createEvent(rinkId, title, description, date, time);
            if (createResult.success) {
                loadEvents();
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–µ—â–µ–Ω–∏–π –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–±—ã—Ç–∏—è (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –æ–Ω–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å)
                loadUserVisitCount();
            } else {
                alert(createResult.message);
            }
        }

        async function loadEvents() {
            const events = await API.getEvents(rinkId);
            if (events.success) {
                const currentUser = Auth.getUser();
                const currentUserId = currentUser ? currentUser.id : null;
                
                let html = '';
                if (events.data.length === 0) {
                    html = '<p class="text-muted">–ù–µ—Ç —Å–æ–±—ã—Ç–∏–π</p>';
                } else {
                    events.data.forEach(event => {
                        const isCreator = event.is_creator || (currentUserId && event.created_by == currentUserId);
                        const isParticipant = event.is_participant || false;
                        const participantsCount = event.participants_count || 0;
                        
                        let joinButton = '';
                        if (Auth.isLoggedIn()) {
                            if (isParticipant) {
                                joinButton = `<button class="btn btn-sm btn-outline-danger" onclick="joinEvent(${event.id})" id="event-btn-${event.id}">–Ø –Ω–µ –ø—Ä–∏–¥—É</button>`;
                            } else {
                                joinButton = `<button class="btn btn-sm btn-primary" onclick="joinEvent(${event.id})" id="event-btn-${event.id}">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>`;
                            }
                        }
                        
                        html += `<div class="card mb-2" id="event-${event.id}">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0">${event.title}</h6>
                                    ${isCreator ? `<button class="btn btn-sm btn-outline-danger" onclick="deleteEvent(${event.id})" title="–£–¥–∞–ª–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ">üóëÔ∏è</button>` : ''}
                                </div>
                                <p class="small mb-2">${event.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                                <p class="small text-muted mb-2">üìÖ ${event.event_date} ${event.event_time || ''}</p>
                                <p class="small mb-2">üë§ –°–æ–∑–¥–∞—Ç–µ–ª—å: ${event.creator_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</p>
                                <p class="small mb-2"><strong>üë• –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: <span id="event-participants-${event.id}">${participantsCount}</span></strong></p>
                                ${joinButton}
                            </div>
                        </div>`;
                    });
                }
                document.getElementById('eventsList').innerHTML = html;
            } else {
                document.getElementById('eventsList').innerHTML = '<p class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π</p>';
            }
        }

        async function joinEvent(eventId) {
            if (!Auth.isLoggedIn()) {
                alert('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É, —á—Ç–æ–±—ã –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —Å–æ–±—ã—Ç–∏—é');
                return;
            }
            
            const result = await API.joinEvent(eventId);
            if (result.success) {
                const participantsSpan = document.getElementById(`event-participants-${eventId}`);
                if (participantsSpan && result.data) {
                    participantsSpan.textContent = result.data.participants_count || 0;
                }
                
                const btn = document.getElementById(`event-btn-${eventId}`);
                if (btn) {
                    if (result.data.is_participant) {
                        btn.textContent = '–Ø –Ω–µ –ø—Ä–∏–¥—É';
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-outline-danger');
                    } else {
                        btn.textContent = '–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è';
                        btn.classList.remove('btn-outline-danger');
                        btn.classList.add('btn-primary');
                    }
                }
            } else {
                alert(result.message);
            }
        }
        
        async function deleteEvent(eventId) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ?')) {
                return;
            }
            
            try {
                if (typeof API.deleteEvent !== 'function') {
                    const result = await API.request(`/events.php?id=${eventId}`, 'DELETE');
                    if (result.success) {
                        loadEvents();
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + (result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                } else {
                    const result = await API.deleteEvent(eventId);
                    if (result.success) {
                        loadEvents();
                    } else {
                        alert('–û—à–∏–±–∫–∞: ' + (result.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
                    }
                }
            } catch (error) {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message);
            }
        }
        
        // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –¥–æ—Å—Ç—É–ø–Ω–æ–π –≥–ª–æ–±–∞–ª—å–Ω–æ
        window.deleteEvent = deleteEvent;

        let popularityChart, ratingsChart;

        async function loadCharts() {
            const reviewsResult = await API.getReviews(rinkId);
            const reviews = reviewsResult.success ? (reviewsResult.data.reviews || []) : [];
            
            const checkinsResult = await API.getCheckins(rinkId, 8760);
            const checkins = checkinsResult.success ? (checkinsResult.data.checkins || []) : [];
            
            const dayNames = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
            const dayCounts = [0, 0, 0, 0, 0, 0, 0];
            
            checkins.forEach(checkin => {
                if (checkin.timestamp) {
                    const date = new Date(checkin.timestamp);
                    const day = date.getDay();
                    const idx = day === 0 ? 6 : day - 1;
                    dayCounts[idx]++;
                }
            });
            
            const hasPopularityData = dayCounts.some(c => c > 0);
            const popularityContainer = document.getElementById('popularityChartContainer');
            const popularityEmpty = document.getElementById('popularityChartEmpty');
            
            if (hasPopularityData) {
                popularityContainer.classList.remove('d-none');
                popularityEmpty.classList.add('d-none');
                
                if (popularityChart) {
                    popularityChart.destroy();
                }
                
                const ctxPopularity = document.getElementById('popularityChart').getContext('2d');
                popularityChart = new Chart(ctxPopularity, {
                    type: 'bar',
                    data: {
                        labels: dayNames,
                        datasets: [{
                            label: '–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å',
                            data: dayCounts,
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(255, 159, 64, 0.8)',
                                'rgba(255, 99, 132, 0.8)'
                            ],
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false },
                            title: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                        }
                    }
                });
            } else {
                popularityContainer.classList.add('d-none');
                popularityEmpty.classList.remove('d-none');
            }

            const ratingCounts = [0, 0, 0, 0, 0];
            reviews.forEach(review => {
                if (review.rating >= 1 && review.rating <= 5) {
                    ratingCounts[review.rating - 1]++;
                }
            });
            
            const hasRatingsData = ratingCounts.some(c => c > 0);
            const ratingsContainer = document.getElementById('ratingsChartContainer');
            const ratingsEmpty = document.getElementById('ratingsChartEmpty');
            
            if (hasRatingsData) {
                ratingsContainer.classList.remove('d-none');
                ratingsEmpty.classList.add('d-none');
                
                if (ratingsChart) {
                    ratingsChart.destroy();
                }
                
                const ctxRatings = document.getElementById('ratingsChart').getContext('2d');
                ratingsChart = new Chart(ctxRatings, {
                    type: 'doughnut',
                    data: {
                        labels: ['‚≠ê 1', '‚≠ê 2', '‚≠ê 3', '‚≠ê 4', '‚≠ê 5'],
                        datasets: [{
                            data: ratingCounts,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(255, 159, 64, 0.8)',
                                'rgba(255, 205, 86, 0.8)',
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(54, 162, 235, 0.8)'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { font: { size: 11 } }
                            }
                        }
                    }
                });
            } else {
                ratingsContainer.classList.add('d-none');
                ratingsEmpty.classList.remove('d-none');
            }
        }

        const originalLoadReviews = window.loadReviews;
        window.loadReviews = async function() {
            if (typeof originalLoadReviews === 'function') {
                await originalLoadReviews();
            }
            loadCharts();
        };

        window.addEventListener('load', () => {
            if (typeof API === 'undefined') {
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ API. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É (Ctrl+F5)');
                return;
            }
            
            if (rinkId) {
                loadRink();
                loadCharts();
                if (typeof loadReviews === 'function') {
                    loadReviews();
                }
                loadEvents();
                loadUserVisitCount();
            }
        });
    </script>
</body>
</html>
