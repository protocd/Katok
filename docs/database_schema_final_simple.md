# Финальная упрощенная схема базы данных
## Веб-приложение "Катки Москвы"
## Соответствует BCNF, включает систему голосования только за отзывы

---

## Концептуальная модель

**Основная идея:** Пользователь и каток связаны через сущность **VISIT (Посещение)**. 
К посещению привязываются отзыв и отметка присутствия.

**Система голосования:** Пользователи голосуют только за отзывы (upvote/downvote). 
Полезные отзывы с информацией о расписании, времени работы и т.д. поднимаются вверх через голосование.

---

## ER-диаграмма (упрощенная)

```
┌─────────────┐
│    USERS    │
│(Пользователи)│
├─────────────┤
│ id (PK)     │
│ email       │
│ ...         │
└──────┬──────┘
       │
       │ 1
       │
  ┌────▼────────────┐
  │     VISITS      │ ◄─── Основная связь
  │   (Посещения)   │      пользователь ↔ каток
  ├─────────────────┤
  │ id (PK)         │
  │ user_id (FK)    │
  │ rink_id (FK)    │
  │ visit_date      │
  └────┬──────┬─────┘
       │      │
       │ 1    │ 1
       │      │
  ┌────▼──┐ ┌─▼──────┐
  │REVIEWS│ │CHECKINS│
  │(Отзывы)│ │(Отметки)│
  ├───────┤ ├────────┤
  │id (PK)│ │id (PK) │
  │visit_ │ │visit_  │
  │  id   │ │  id    │
  │text   │ │...     │
  │rating │ │        │
  │score  │ │        │ ◄─── Рейтинг голосования
  │...    │ │        │      (upvotes - downvotes)
  └───┬───┘ └────────┘
      │
      │ 1
      │
  ┌───▼──────────────┐
  │      VOTES       │ ◄─── Голосование
  │   (Голоса)       │      только за отзывы
  ├──────────────────┤
  │ id (PK)          │
  │ user_id (FK)     │
  │ review_id (FK)   │
  │ vote_type        │
  │ (up/down)        │
  └──────────────────┘

┌─────────────┐
│    RINKS    │
│   (Катки)   │
└─────────────┘
```

---

## Структура таблиц

### 1. `users` - Пользователи
- Стандартная таблица пользователей
- Email, пароль, имя, роль

### 2. `rinks` - Катки
- Информация о катках из открытых данных
- Адрес, координаты, инфраструктура

### 3. `visits` - Посещения ⭐ КЛЮЧЕВАЯ СУЩНОСТЬ
- Связывает пользователя и каток
- Один пользователь = одно посещение катка в день
- UNIQUE (user_id, rink_id, visit_date)

### 4. `reviews` - Отзывы
- Привязаны к посещению (1:1)
- Текст отзыва, рейтинг, оценки
- **score** - рейтинг голосования (upvotes - downvotes)
- **upvotes_count**, **downvotes_count** - счетчики

### 5. `checkins` - Отметки присутствия
- Привязаны к посещению (1:N)
- Несколько отметок в течение одного посещения
- Геолокация, расстояние, IP-адрес

### 6. `votes` - Голоса ⭐ ТОЛЬКО ЗА ОТЗЫВЫ
- Голосование за отзывы (upvote/downvote)
- UNIQUE (user_id, review_id) - один голос на отзыв
- Можно изменить голос (up → down или наоборот)

### 7. `suspicious_activity` - Подозрительная активность
- Логирование для защиты от накруток

---

## Логика работы

### Голосование за отзывы:

1. **Пользователь нажимает "вверх" (upvote):**
   - Если голоса нет → создается запись с `vote_type = 'up'`
   - Если есть `vote_type = 'down'` → обновляется на `'up'`
   - Если есть `vote_type = 'up'` → удаляется (отмена upvote)

2. **Пользователь нажимает "вниз" (downvote):**
   - Аналогично, но с `vote_type = 'down'`

3. **Обновление счетчиков:**
   - `upvotes_count` = COUNT(votes WHERE vote_type = 'up')
   - `downvotes_count` = COUNT(votes WHERE vote_type = 'down')
   - `score` = upvotes_count - downvotes_count

### Сортировка отзывов:

1. **По рейтингу (по умолчанию):** ORDER BY score DESC, created_at DESC
   - Самые полезные отзывы (с информацией о расписании, времени работы) поднимаются вверх

2. **По дате:** ORDER BY created_at DESC
   - Новые отзывы первыми

3. **По количеству upvotes:** ORDER BY upvotes_count DESC

### Отображение рейтинга:

- **Положительный:** `+17` (17 upvotes больше, чем downvotes)
- **Отрицательный:** `-5` (5 downvotes больше, чем upvotes)
- **Нулевой:** `0` (равное количество)

---

## Преимущества упрощенной структуры

1. **Проще в реализации:**
   - Меньше таблиц
   - Меньше связей
   - Проще логика

2. **Логично:**
   - Полезные отзывы с информацией о расписании поднимаются через голосование
   - Не нужна отдельная таблица для фото расписания
   - Всё в отзывах

3. **Саморегуляция:**
   - Пользователи сами определяют полезность отзывов
   - Отзывы с актуальной информацией получают больше upvotes
   - Неполезные отзывы опускаются вниз

---

## Итоговая структура БД

**Таблицы:**
1. `users` - пользователи
2. `rinks` - катки
3. `visits` - посещения ⭐
4. `reviews` - отзывы (с рейтингом голосования)
5. `checkins` - отметки присутствия
6. `votes` - голоса за отзывы ⭐
7. `suspicious_activity` - логирование

**Нормализация:** BCNF ✓

**Система голосования:** Reddit-style (upvote/downvote) только для отзывов ✓
